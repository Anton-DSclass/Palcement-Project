import mysql.connector
import pandas as pd
import streamlit as st

# ===================== DB CONNECTION =====================
def get_connection():
    return mysql.connector.connect(
        host="localhost",
        user="root",
        password="Anton@19801024",
        port=3306,
        database="Placement_project"
    )

def execute_query(query, params=None):
    conn = get_connection()
    df = pd.read_sql(query, conn, params=params)
    conn.close()
    return df

# ===================== STREAMLIT UI =====================
st.title("ðŸŽ“ Student Placement Dashboard")

# ------------------ Programming Language Filter ------------------
st.subheader("ðŸ“Š Programming Language - Student Details")

# Sidebar for language filter
st.sidebar.header("Filter")
selected_language = st.sidebar.selectbox(
    "Select Programming Language",
    options=["Python", "Java", "C++"]
)

# Query for filtered students
query_lang = """
SELECT sr.student_id, sr.student_name, sr.student_age, sr.student_gender,
       sr.student_email, ps.language, ps.problems_solved, ps.latest_project_score
FROM student_records sr
JOIN programming_skills ps ON sr.student_id = ps.student_id
WHERE ps.language = %s
"""

df_lang = execute_query(query_lang, (selected_language,))
st.subheader(f"Students with {selected_language} as Programming Language")
st.dataframe(df_lang)

# ------------------ Top 10 Reports ------------------
queries = {
    "1. View All Students": "SELECT * FROM student_records;",

    "2. Python Programmers Only": """
        SELECT sr.student_id, sr.student_name, ps.language
        FROM student_records sr
        JOIN programming_skills ps ON sr.student_id = ps.student_id
        WHERE ps.language = 'Python';
    """,

    "3. Top 10 by Problem Solving": """
        SELECT sr.student_name, ps.language, ps.problems_solved
        FROM student_records sr
        JOIN programming_skills ps ON sr.student_id = ps.student_id
        ORDER BY ps.problems_solved DESC
        LIMIT 10;
    """,

    "4. Students with Internship Experience": """
        SELECT sr.student_name, p.internships_completed
        FROM student_records sr
        JOIN placements p ON sr.student_id = p.student_id
        WHERE p.internships_completed > 0;
    """,

    "5. Placed Students with Packages > 10 LPA": """
        SELECT sr.student_name, p.company_name, p.placement_package
        FROM student_records sr
        JOIN placements p ON sr.student_id = p.student_id
        WHERE p.placement_status = 'Placed' AND p.placement_package > 10;
    """,

    "6. Students Good at Soft Skills (score > 8 in all)": """
        SELECT sr.student_name
        FROM student_records sr
        JOIN soft_skills ss ON sr.student_id = ss.student_id
        WHERE ss.communication > 8 AND ss.teamwork > 8 AND ss.presentation > 8 AND 
              ss.leadership > 8 AND ss.critical_thinking > 8 AND ss.interpersonal_skills > 8;
    """,

    "7. Final Year Students (Graduation 2023)": """
        SELECT student_name, graduation_year
        FROM student_records
        WHERE graduation_year = 2023;
    """,

    "8. Students Cleared > 3 Interview Rounds": """
        SELECT sr.student_name, p.interview_rounds_cleared
        FROM student_records sr
        JOIN placements p ON sr.student_id = p.student_id
        WHERE p.interview_rounds_cleared > 3;
    """,

    "9. Students with Project Score < 50": """
        SELECT sr.student_name, ps.language, ps.latest_project_score
        FROM student_records sr
        JOIN programming_skills ps ON sr.student_id = ps.student_id
        WHERE ps.latest_project_score < 50;
    """,

    "10. Students from City 'Chennai' Studying Java": """
        SELECT sr.student_name, sr.student_city, ps.language
        FROM student_records sr
        JOIN programming_skills ps ON sr.student_id = ps.student_id
        WHERE sr.student_city = 'Chennai' AND ps.language = 'Java';
    """
}

# ------------------ Query Explorer ------------------
st.subheader("ðŸ“Œ Explore Reports")

selected_query = st.selectbox("Choose a Report:", list(queries.keys()))

if st.button("Run Query"):
    with st.spinner("Executing..."):
        df = execute_query(queries[selected_query])
        st.success("Query executed successfully!")
        st.dataframe(df)
